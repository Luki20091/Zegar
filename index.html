<!DOCTYPE html>
<html lang="pl">
<head>
	<title>Test</title>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
</head>
<body>
    <table id="tab" border="1" ></table>
    <div id="clock">
        <h2 id="time"></h2>
        <p id="lesson"></p>
        <div id="progress">
        </div>
    </div>
    <iframe id="cors" src="https://cors-anywhere.herokuapp.com/corsdemo" hidden></iframe>
    <script>
        window.onload = function () {
            $("#cors").contents().find("body > form > p:nth-child(2) > input[type=submit]:nth-child(1)").click();
        };

        const targetUrl = 'https://www.zst-radom.edu.pl/plan_www/plany/o28.html';
        const proxyUrl = 'https://cors-anywhere.herokuapp.com/';

        fetch(proxyUrl + targetUrl)
            .then(response => response.text())
            .then(data => send(data))
            .catch(error => console.error('Error:', error));

        function send(data) {
            const parser = new DOMParser();
            const html = parser.parseFromString(data, 'text/html');
            const body = html.body;

            document.getElementById("tab").innerHTML = body.querySelector("div > table > tbody > tr:nth-child(1) > td > table").innerHTML;
            clock();
        }




        function clock() {
            var date = new Date();
            var h = date.getHours();
            var m = date.getMinutes();
            //var h = 10;
            //var m = 40;
            var s = date.getSeconds();
            var hm = h * 60 + m;


            var x = 1;
            while (document.querySelector(`th:nth-child(${x})`) != null && document.querySelector(`th:nth-child(${x})`).innerText.toLowerCase() != getDayName(date)) {
                x++;
            };



            var y = 2;
            while (document.querySelector(`tr:nth-child(${y}) td.g:nth-child(2)`) != null) {
                var yVal = document.querySelector(`tr:nth-child(${y}) td.g:nth-child(2)`).innerText.split('-');
                var yVal1 = yVal[0].trim().split(':');
                var yVal2 = yVal[1].trim().split(':');

                var yVal1Hm = parseInt(yVal1[0]) * 60 + parseInt(yVal1[1]);
                var yVal2Hm = parseInt(yVal2[0]) * 60 + parseInt(yVal2[1]);

                //console.log('spr lekcje miêdzy: ' + yVal1 + ' a ' + yVal2);
                if (hm >= yVal1Hm && hm < yVal2Hm) {
                    setLesson(x, y, hm, yVal1Hm, yVal2Hm);
                    break;
                };
                if (document.querySelector(`tr:nth-child(${y + 1}) td.g:nth-child(2)`) != null) {
                    var y1Val = document.querySelector(`tr:nth-child(${y + 1}) td.g:nth-child(2)`).innerText.split('-');
                    var y1Val1 = y1Val[0].trim().split(':');

                    var y1Val1Hm = parseInt(y1Val1[0]) * 60 + parseInt(y1Val1[1]);

                    //console.log('spr przerwe miêdzy: ' + yVal2 + ' a ' + y1Val1);
                    if (hm >= yVal2Hm && hm < y1Val1Hm) {
                        setBreak(x, y + 1, hm, yVal2Hm, y1Val1Hm);
                        break;
                    };
                };
                y++;
            };

            if (document.querySelector(`tr:nth-child(${y}) td.g:nth-child(2)`) == null) {
                setBreak(x, y, hm, yVal1Hm, yVal2Hm);
            };



            if (m < 10) m = "0" + m;
            if (s < 10) s = "0" + s;
            var time = h + ":" + m + ":" + s;
            document.getElementById("time").innerHTML = time;
        };

        function getDayName(date = new Date(), locale = 'pl-PL') {
            return date.toLocaleDateString(locale, { weekday: 'long' });
        };


        function setLesson(x, y, hm, t1, t2) {
            if (document.querySelector(`tr:nth-child(${y}) > td:nth-child(${x}) span.p:nth-child(1)`) != null) {
                document.getElementById("lesson").innerHTML = ('Przerwa: ' + (t2 - hm) + 'm, ' + (((t2 - hm) / (t2 - t1)) * 100) + '%');
            } else {
                document.getElementById("lesson").innerHTML = ('Brak lekcji');
            }
        };

        function setBreak(x, y, hm, t1, t2) {
            if (document.querySelector(`tr:nth-child(${y}) > td:nth-child(${x}) span.p:nth-child(1)`) != null && document.querySelector(`tr:nth-child(${y}) > td:nth-child(${x}) span.p:nth-child(1)`).innerText.includes('-2/2') != true) {
                document.getElementById("lesson").innerHTML = (document.querySelector(`tr:nth-child(${y}) > td:nth-child(${x}) span.p:nth-child(1)`).innerText.replace('-1/2', '').replace('j.polski', 'Polski').replace('j.angielski', 'Angielski').replace('j.niemiecki', 'Niemiecki').replace('r_matematyka', 'Matematyka').replace('r_fizyka', 'Fizyka').replace('progr.apl.in', 'Internetowe').replace('Progr.obiekt', 'Objektowe').replace('proj.i ad.ba', 'Bazy danych').replace('Pro.apl.desk', 'Desktopowe').replace('godz.wych', 'Wychowawcza') + ' ' + document.querySelector(`tr:nth-child(${y}) > td:nth-child(${x}) span.s:nth-child(3)`).innerText + ': ' + (t2 - hm) + 'm, ' + (((t2 - hm) / (t2 - t1)) * 100) + '%');
            } else {
                document.getElementById("lesson").innerHTML = ('Brak lekcji');
            };
        };


        //j.polski         Polski
        //j.angielski      Angielski
        //j.niemiecki      Niemiecki
        //r_matematyka     Matematyka
        //r_fizyka         Fizyka
        //progr.apl.in     Internetowe
        //Progr.obiekt     Objektowe
        //proj.i ad.ba     Bazy danych
        //Pro.apl.desk     Desktopowe
        //godz.wych        Wychowawcza
        //
        //
        //.replace('j.polski', 'Polski').replace('j.angielski', 'Angielski').replace('j.niemiecki', 'Niemiecki').replace('r_matematyka', 'Matematyka').replace('r_fizyka', 'Fizyka').replace('progr.apl.in', 'Internetowe').replace('Progr.obiekt', 'Objektowe').replace('proj.i ad.ba', 'Bazy danych').replace('Pro.apl.desk', 'Desktopowe').replace('godz.wych', 'Wychowawcza')


                //sprawdza dzieñ (x)
                    // document.querySelector("th:nth-child(x)").innerText;
                    // zakres 3-7

                //sprawdza godzinê (y)
                    // document.querySelector(" tr:nth-child(y) td.g:nth-child(2)").innerText;
                    // zakres: 2-y


                //dostêp przez (x, y)
                    // document.querySelector("tr:nth-child(y) > td:nth-child(x) span.p:nth-child(1)").innerText;
                    //zakres 2.3-y.7

                    //null = koniec lekcji





                //nie trzeba pobieraæ wysokoœci tabeli: null = koniec

            //nie dawaæ w js zamieniania wielkoœci pierwszej litery, tylko w css
            //#selector:: first - letter {
            //    text - transform: uppercase;
            //}


            //w przysz³oœci dodaæ aktualny dzieñ z boku np.
            //lub poprzedni¹ lekcjê i nastêpn¹ => nad i pod

    </script>
</body>
</html>
